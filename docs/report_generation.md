# 报告生成说明

## 概述
报告生成是OpenRA系统的核心功能之一，用于将代码审计和审查的结果以结构化、专业的方式呈现。系统支持多种报告格式，包括Markdown、PDF和JSON，满足不同场景的需求。

## 支持的报告格式

### 1. Markdown格式
**扩展名**：`.md`
**特点**：
- 纯文本格式，易于阅读和编辑
- 支持基本的格式化（标题、列表、代码块等）
- 可以直接在GitHub、GitLab等平台上显示
- 生成速度快，占用空间小

### 2. PDF格式
**扩展名**：`.pdf`
**特点**：
- 专业的文档格式，布局美观
- 支持复杂的排版和样式
- 适合正式场合和打印
- 参考DeepAudit的专业审计版设计

### 3. JSON格式
**扩展名**：`.json`
**特点**：
- 结构化数据格式，易于机器处理
- 包含完整的审计结果数据
- 适合与其他系统集成
- 方便进行数据统计和分析

## PDF报告结构

PDF报告采用专业审计报告的结构和样式，参考DeepAudit的实现：

### 1. 报告头部
- **标题**：代码审计报告
- **副标题**：包含项目信息、分析类型等
- **元信息**：报告编号、生成时间
- **logo**：系统标志

### 2. 概览区域
- **代码质量评分**：0-100分的质量评分
- **统计数据**：问题总数、耗时等关键指标
- **评分栏**：突出显示代码质量评分

### 3. 问题详情
- **问题列表**：按严重程度排序的问题列表
- **问题项**：每个问题包含以下信息：
  - 问题标题和编号
  - 严重程度（CRITICAL、HIGH、MEDIUM、LOW）
  - 位置信息（文件路径、行号）
  - 问题描述
  - 代码片段（如有）
  - 修复建议

### 4. 页脚
- **声明**：报告由AI自动生成，注意核实鉴别

## 报告生成流程

### 1. 数据收集
- 收集代码审计或审查的结果
- 整理问题列表，按严重程度排序
- 计算代码质量评分和统计数据

### 2. 模板渲染
- 根据选择的格式，选择相应的模板
- 将审计数据填充到模板中
- 应用样式和布局

### 3. 格式转换
- **Markdown**：直接生成Markdown文本
- **PDF**：使用WeasyPrint将HTML转换为PDF
- **JSON**：将数据序列化为JSON格式

### 4. 保存和推送
- 将生成的报告保存到本地文件
- 对于远程仓库，推送报告到仓库的相应目录

## 报告生成的使用方法

### 通过CLI使用
```bash
# 生成Markdown格式报告
python -m src.cli.main --output md audit --local

# 生成PDF格式报告
python -m src.cli.main --output pdf audit --local

# 生成JSON格式报告
python -m src.cli.main --output json audit --local
```

### 通过配置文件使用
在`config/.env`文件中设置默认输出格式：
```
# 默认输出格式
DEFAULT_OUTPUT_FORMAT="md"
```

## 报告推送功能

### 本地仓库
- 报告保存在当前目录
- 文件名格式：`report_<type>.<format>`

### 远程仓库
- 报告推送至仓库的`report_<type>`目录
- 如果目录不存在，自动创建
- 推送后自动提交和推送更改

## 报告模板定制

### 1. Markdown模板
可以通过修改`src/core/report_generator.py`中的Markdown生成逻辑来定制：
- 修改报告结构和格式
- 调整内容组织方式
- 添加或删除报告 sections

### 2. PDF模板
PDF报告使用HTML/CSS模板，可以通过以下方式定制：
- 修改HTML结构
- 调整CSS样式
- 添加自定义元素
- 修改字体和颜色方案

### 3. JSON结构
JSON报告的结构可以通过修改数据模型来定制：
- 添加或删除字段
- 调整数据组织方式
- 优化数据结构

## 报告生成的最佳实践

1. **选择合适的格式**：根据使用场景选择最适合的报告格式
2. **结合使用**：对于重要项目，可以同时生成多种格式的报告
3. **定期生成**：定期生成报告，跟踪代码质量的变化
4. **分享和讨论**：将报告分享给团队成员，讨论发现的问题
5. **持续改进**：根据报告结果，持续改进代码质量

## 示例：PDF报告

### 报告头部
```
代码审计报告
即时分析 | 语言: Python

报告编号: INST-1234567890
生成时间: 2026-02-10 14:30:00
```

### 概览区域
```
代码质量评分: 75/100

问题总数: 5 | 耗时: 12.34s
```

### 问题详情
```
1. SQL注入漏洞 [HIGH]
FILE: example.py | LINE: 7
使用字符串拼接构建SQL查询，存在SQL注入风险

代码片段:
query = f"SELECT * FROM users WHERE id = {user_id}"

建议: 使用参数化查询
```

## 性能考虑

- **生成速度**：Markdown > JSON > PDF
- **文件大小**：PDF > JSON > Markdown
- **资源消耗**：PDF生成需要更多的CPU和内存资源
- **建议**：对于大型项目，考虑先使用Markdown或JSON格式进行初步分析

## 故障排除

### 常见问题

1. **PDF生成失败**
   - 原因：缺少WeasyPrint依赖
   - 解决：安装所需依赖：`pip install weasyprint reportlab`

2. **报告推送失败**
   - 原因：Git权限不足或网络问题
   - 解决：确保有正确的Git权限，检查网络连接

3. **报告格式错误**
   - 原因：数据格式不正确或模板问题
   - 解决：检查审计结果数据，验证模板配置

4. **生成速度慢**
   - 原因：项目过大或PDF生成耗时
   - 解决：使用Markdown格式，或分批次处理大型项目

## 与DeepAudit的关系

OpenRA的报告生成功能参考了DeepAudit的实现，特别是PDF报告的结构和样式。主要改进包括：

- 适配OpenRA的CLI模式
- 支持多种输出格式
- 优化远程仓库的报告推送
- 简化配置和使用流程