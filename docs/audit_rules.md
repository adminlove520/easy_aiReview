# 审计规则说明

## 概述
审计规则是OpenRA系统中用于指导代码审计过程的规则集合，定义了需要检查的问题类型、严重程度和处理方法。系统预置了多种规则集，同时支持自定义规则，以适应不同项目的需求。

## 系统预置规则集

### 1. OWASP Top 10规则集
**描述**：基于OWASP Top 10 2021的安全审计规则集
**适用场景**：安全审计的核心规则集
**规则类型**：security

**包含的规则**：

| 规则代码 | 名称 | 严重程度 | 描述 |
|---------|------|----------|------|
| A01 | 访问控制失效 | critical | 检测权限绕过、越权访问、IDOR等访问控制问题 |
| A02 | 加密机制失效 | critical | 检测弱加密、明文传输、密钥管理不当等问题 |
| A03 | 注入攻击 | critical | 检测SQL注入、命令注入、LDAP注入等注入漏洞 |
| A04 | 不安全设计 | high | 检测业务逻辑漏洞、缺少安全控制等设计问题 |
| A05 | 安全配置错误 | high | 检测默认配置、不必要的功能、错误的权限设置 |
| A06 | 易受攻击和过时的组件 | high | 检测使用已知漏洞的依赖库 |
| A07 | 身份认证失效 | critical | 检测弱密码、会话管理问题、凭证泄露 |
| A08 | 软件和数据完整性失效 | critical | 检测不安全的反序列化、CI/CD安全问题 |
| A09 | 安全日志和监控失效 | medium | 检测日志记录不足、监控缺失 |
| A10 | 服务端请求伪造(SSRF) | high | 检测SSRF漏洞 |

### 2. 代码质量规则集
**描述**：通用代码质量检查规则集
**适用场景**：代码质量审计
**规则类型**：quality

**包含的规则**：

| 规则代码 | 名称 | 严重程度 | 描述 |
|---------|------|----------|------|
| CQ001 | 函数过长 | medium | 函数超过50行，建议拆分 |
| CQ002 | 重复代码 | medium | 检测重复的代码块 |
| CQ003 | 嵌套过深 | low | 代码嵌套层级超过4层 |
| CQ004 | 魔法数字 | low | 代码中使用未命名的常量 |
| CQ005 | 缺少错误处理 | high | 缺少异常捕获或错误处理 |
| CQ006 | 未使用的变量 | low | 声明但未使用的变量 |
| CQ007 | 命名不规范 | low | 变量、函数、类命名不符合规范 |
| CQ008 | 注释缺失 | low | 复杂逻辑缺少必要注释 |

### 3. 性能优化规则集
**描述**：性能问题检测规则集
**适用场景**：性能优化审计
**规则类型**：performance

**包含的规则**：

| 规则代码 | 名称 | 严重程度 | 描述 |
|---------|------|----------|------|
| PERF001 | N+1查询 | high | 检测数据库N+1查询问题 |
| PERF002 | 内存泄漏 | critical | 检测潜在的内存泄漏 |
| PERF003 | 低效算法 | medium | 检测时间复杂度过高的算法 |
| PERF004 | 不必要的对象创建 | medium | 在循环中创建不必要的对象 |
| PERF005 | 同步阻塞 | medium | 检测同步阻塞操作 |

## 规则的严重程度

系统使用以下严重程度等级：

| 严重程度 | 描述 | 权重 |
|---------|------|------|
| critical | 严重 | 10 |
| high | 高 | 5 |
| medium | 中 | 2 |
| low | 低 | 1 |

权重用于计算代码质量评分，严重的问题会对评分产生更大的影响。

## 规则的分类

规则按类别进行组织，主要包括：

- **security**：安全相关问题
- **maintainability**：可维护性问题
- **performance**：性能问题
- **style**：代码风格问题
- **bug**：潜在的bug

## 自定义审计规则

### 创建自定义规则集
1. 登录系统后台
2. 导航到「审计规则」页面
3. 点击「创建规则集」按钮
4. 填写规则集名称、描述、语言等信息
5. 设置严重程度权重
6. 保存规则集

### 创建自定义规则
1. 在规则集详情页面，点击「添加规则」按钮
2. 填写规则代码、名称、描述等信息
3. 设置规则的类别和严重程度
4. 编写自定义提示词和修复建议
5. 保存规则

### 管理规则
- **启用/禁用**：可以启用或禁用特定的规则
- **编辑**：修改现有规则的内容和设置
- **删除**：删除不需要的规则
- **排序**：调整规则的顺序

## 规则的工作原理

### 规则应用流程
1. **规则选择**：根据审计类型和配置选择适用的规则集
2. **规则执行**：对代码应用每条规则进行检查
3. **问题检测**：根据规则的提示词检测潜在问题
4. **严重程度评估**：根据规则的严重程度评估问题
5. **结果汇总**：汇总所有检测到的问题

### 规则的自定义提示词

每条规则都可以有自定义的提示词，用于指导AI更准确地检测问题：

```
检查是否存在访问控制失效问题：权限检查缺失、越权访问、IDOR（不安全的直接对象引用）、CORS配置错误
```

### 规则的修复建议

每条规则都可以包含修复建议，用于指导开发者解决问题：

```
实施最小权限原则，在服务端进行权限验证，使用基于角色的访问控制(RBAC)
```

## 规则集的使用方法

### 通过CLI使用
```bash
# 使用默认规则集进行审计
python -m src.cli.main audit --local

# 通过配置文件指定规则集
python -m src.cli.main audit --local
```

### 通过配置文件使用
在`config/.env`文件中设置：

```
# 默认规则集
DEFAULT_RULE_SET="OWASP Top 10"

# 启用的规则集
ENABLED_RULE_SETS="OWASP Top 10,代码质量规则"
```

## 规则的最佳实践

1. **选择合适的规则集**：根据审计目标选择最适合的规则集
2. **组合使用**：对于全面审计，组合使用多个规则集
3. **调整严重程度**：根据项目特点，调整规则的严重程度
4. **自定义规则**：根据项目的具体需求，创建自定义规则
5. **定期更新**：随着安全威胁和最佳实践的变化，定期更新规则
6. **规则优化**：根据审计结果，不断优化规则的提示词和修复建议

## 规则集的性能影响

- **规则数量**：规则数量越多，审计时间越长
- **规则复杂度**：规则越复杂，AI处理时间越长
- **建议**：
  - 对于快速审计，使用较少的核心规则
  - 对于深度审计，使用完整的规则集
  - 对于大型项目，考虑分模块进行审计

## 与DeepAudit的关系

OpenRA的审计规则系统参考了DeepAudit的实现，主要特点包括：

- **规则集管理**：支持多个规则集的管理和使用
- **严重程度权重**：基于严重程度计算代码质量评分
- **自定义能力**：支持创建和管理自定义规则
- **OWASP集成**：集成了OWASP Top 10规则

主要改进包括：

- 适配OpenRA的CLI模式
- 简化规则管理流程
- 优化规则应用逻辑
- 增强规则的可扩展性